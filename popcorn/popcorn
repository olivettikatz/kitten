#!/usr/bin/env python3

import os
import sys
import shutil

def usage():
	print("usage: popcorn --create *.pop")
	print("       popcorn --pop *.tar|*.tgz")
	print()
	print("Pop files are divided into lines by newline characters. A line may const of a single filename, relative to the directory of the *.pop file or two filenames, the source of the file and the destination of where it will be copied to upon popping.")
	print()
	print("example.pop:")
	print("a.txt")
	print("b.txt c.txt")
	print()
	print("Example usage:")
	print("$ ls")
	print("a.txt b.txt example.pop")
	print("$ popcorn --create example.pop")
	print("$ ls")
	print("a.txt b.txt example.pop example.tar")
	print("$ popcorn --pop example.tar")
	print("$ ls")
	print("a.txt b.txt c.txt example.pop example.tar")

try:
	if sys.argv[1] == "--create":
		f = open(sys.argv[2], "r")
		p = f.read()
		f.close()

		script = "#!/bin/bash\n"
		script += "# Auto-Generated by kitten/popcorn 0.01-alpha\n"

		working = os.path.dirname(sys.argv[2])
		kernelname = os.path.splitext(os.path.basename(sys.argv[2]))[0]

		tmpdir = os.path.join(working, kernelname+".tmp")
		os.mkdir(tmpdir)

		n = 0
		for i in p.split("\n"):
			if i == "":
				continue
			src = ""
			dst = ""
			name = os.path.join(tmpdir, str(n)+".kernel")
			n += 1
			if " " in i:
				src = i.split(" ")[0]
				dst = i.split(" ")[1]
			else:
				src = dst = i

			shutil.copytree(src, name)
			script += "cp -r "+name+" "+dst+"\n"

		f = open(os.path.join(tmpdir, "pop.bash"), "w")
		f.write(script)
		f.close()

		os.system("tar cf "+os.path.join(working, kernelname+".tar")+" "+tmpdir)
		shutil.rmtree(tmpdir)
	elif sys.argv[1] == "--pop":
		os.system("tar xf "+sys.argv[2])
		os.system("bash "+os.path.join(os.path.splitext(sys.argv[2])[0]+".tmp", "pop.bash"))
		shutil.rmtree(os.path.splitext(sys.argv[2])[0]+".tmp")
	else:
		usage()
except IndexError:
	usage()
